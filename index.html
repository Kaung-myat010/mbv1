<!doctype html>
<html lang="en"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
  <meta name="theme-color" content="#6800f1"> 
  <meta name="apple-mobile-web-app-capable" content="yes"> 
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
  <link rel="apple-touch-icon" href="/mbv1/icons/icon-192x192.png"> 
  <link rel="apple-touch-icon" sizes="512x512" href="/mbv1/icons/icon-512x512.png"> 
  <link rel="manifest" href="/mbv1/manifest.json">
  <link rel="manifest" href="/mbv1/sw.js"> 
  <title>Maybal</title> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"> 
  <link href="https://fonts.googleapis.com/css2?family=Padauk&amp;display=swap" rel="stylesheet"> 
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar&amp;display=swap" rel="stylesheet"> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 
  <style>
        /* --- GLOBAL STYLES & LAYOUT --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Padauk', 'Myanmar Text', 'Noto Sans Myanmar', sans-serif;
        }

        body {
            font-family: 'Segoe UI', 'Padauk', 'Myanmar Text', 'Noto Sans Myanmar', sans-serif;
            background: linear-gradient(45deg, #e7bedc, #e7bedc, #a666da, #b85ea9, #b85ea9, #e7bedc, #e7bedc, #e7bedc);
            background-size: 600% 600%;
            animation: gradientBG 15s ease infinite;
            color: #3A3A3A;
            padding-bottom: 70px; /* Space for footer menu */
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .app-section {
            display: none;
            padding: 20px;
        }

        .app-section.active {
            display: block;
        }

        #footer-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s ease-in-out;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #888;
            transition: color 0.3s ease, transform 0.2s ease;
            flex-grow: 1;
            padding: 5px 0;
        }

        .menu-item i {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .menu-item span {
            font-size: 11px;
            font-weight: 500;
        }

        .menu-item.active {
            color: #6800f1;
            transform: scale(1.1);
        }
        
        /* --- SECTION 1: VOUCHER GENERATOR STYLES --- */
        #voucher-generator-section .container {
            max-width: 600px; margin: 20px auto; padding: 20px;
            background: rgba(255, 255, 255, 0.692); border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2); position: relative;
        }
        #voucher-generator-section h1 { text-align: center; color: rgba(104, 0, 241, 0.753); text-shadow: 0 0 8px #ffffffa4; margin-bottom: 15px; margin-top: 40px; }
        #voucher-generator-section h2 { text-align: center; color: rgba(104, 0, 241, 0.753); text-shadow: 0 0 8px #ffffffa4; margin-bottom: 10px; margin-top: 60px; }
        #voucher-generator-section .aaa { text-align: center; font-size: 10px; color: rgba(56, 43, 43, 0.5); margin-top: 5px; }
        #voucher-generator-section #detailsForm { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        #voucher-generator-section form input { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: rgba(255, 255, 255, 0.7); color: #3A3A3A; }
        #voucher-generator-section #addColumnContainer { position: absolute; top: 276px; left: 20px; z-index: 10; }
        #voucher-generator-section #addColumnBtn { background: linear-gradient(45deg, rgb(133, 61, 228), rgb(169, 117, 238)); color: white; padding: 10px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 3px 8px rgba(0, 0, 0, 0.253); transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); width: 120px; text-align: center; }
        #voucher-generator-section #addColumnBtn:hover { background: linear-gradient(-45deg, rgb(133, 61, 228), rgb(169, 117, 238)); transform: scale(1.05); }
        #voucher-generator-section #columnOptions { position: absolute; top: 100%; left: 0; background: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: none; z-index: 20; }
        #voucher-generator-section .column-option { padding: 10px 20px; cursor: pointer; transition: background 0.2s; }
        #voucher-generator-section .column-option:hover { background: rgba(104, 0, 241, 0.1); }
        #voucher-generator-section #dynamicIsland { position: absolute; top: 200px; left: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 10px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2), 0 0 15px rgba(104, 0, 241, 0.3); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.3); transform: scale(0); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 30; display: flex; gap: 10px; }
        #voucher-generator-section #dynamicIsland.visible { transform: scale(1); opacity: 1; }
        #voucher-generator-section .action-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; color: white; font-size: 18px; }
        #voucher-generator-section .action-icon:hover { transform: scale(1.1); box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); }
        #voucher-generator-section .delete-icon { background: linear-gradient(45deg, rgb(218, 71, 103), rgb(240, 131, 154)); }
        #voucher-generator-section .save-icon { background: linear-gradient(45deg, rgb(133, 61, 228), rgb(169, 117, 238)); }
        #voucher-generator-section #voucher { margin-top: 25px; background-size: cover; background-position: center; background-repeat: no-repeat; position: relative; padding: 8px; border-radius: 10px; margin-top: 70px; box-shadow: inset 0 0 0 1000px rgba(255, 255, 255, 0.897); }
        #voucher-generator-section #voucher.has-bg::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(249, 219, 255, 0.664); z-index: 1; border-radius: 10px; }
        #voucher-generator-section #voucher > * { position: relative; z-index: 2; }
        #voucher-generator-section .voucher-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: bold; color: rgba(104, 0, 241, 0.753); }
        #voucher-generator-section .location { position: absolute; left: 20px; display: flex; font-weight: bold; color: rgba(104, 0, 241, 0.753); z-index: 2; }
        #voucher-generator-section .location-text i { font-size: 15px; font-weight: bold; margin-right: 8px; color: rgba(104, 0, 241, 0.753); display: flex; align-items: center; }
        #voucher-generator-section .location-text { font-size: 15px; margin-right: 8px; color: rgba(104, 0, 241, 0.753); display: flex; }
        #voucher-generator-section .phone { font-size: 15px; color: rgba(104, 0, 241, 0.753); display: flex; align-items: center; padding-left: 15px; }
        #voucher-generator-section .phone i { margin-right: 8px; color: rgba(104, 0, 241, 0.753); }
        #voucher-generator-section table { background: transparent; width: 100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; margin-bottom: 10px; }
        #voucher-generator-section th, #voucher-generator-section td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; background: linear-gradient(45deg, #ffe6ffb2, #f5e4ffad); }
        #voucher-generator-section th { background: rgb(116, 42, 214); color: white; font-weight: bold; }
        #voucher-generator-section th:nth-child(1), #voucher-generator-section td.item-name { width: 40%; min-width: 200px; white-space: normal; word-wrap: break-word; }
        #voucher-generator-section th:nth-child(2), #voucher-generator-section td.quantity { width: 9%; min-width: 60px; }
        #voucher-generator-section th:nth-child(3), #voucher-generator-section td.price { width: 23%; min-width: 100px; }
        #voucher-generator-section th:nth-child(4), #voucher-generator-section td.total { width: 23%; min-width: 100px; white-space: normal; word-wrap: break-word; font-weight: bold; }
        #voucher-generator-section tr:hover { background: rgba(0, 0, 0, 0.05); }
        #voucher-generator-section td input { width: 100%; padding: 5px; border: none; background: transparent; text-align: center; color: #2c2c2c; font-weight: bold; font-size: 15px; }
        #voucher-generator-section td input:focus { outline: none; background: rgba(255, 255, 255, 0.2); }
        #voucher-generator-section .item-name { cursor: pointer; transition: color 0.3s ease; position: relative; }
        #voucher-generator-section .item-name:hover { color: rgb(125, 43, 231); }
        #voucher-generator-section .item-name-container { position: relative; }
        #voucher-generator-section .item-name-dropdown { position: absolute; top: 100%; left: 0; width: 250px; max-height: 250px; overflow-y: auto; background: rgba(255, 255, 255, 0.95); border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); z-index: 40; display: none; font-weight: bold; font-size: 16px; }
        #voucher-generator-section .dropdown-item { padding: 12px 15px; cursor: pointer; transition: background 0.2s; }
        #voucher-generator-section .dropdown-item:hover { background: rgba(104, 0, 241, 0.1); }
        #voucher-generator-section #grandTotal { font-size: 18px; text-align: center; margin-top: 10px; font-weight: bold; color: #2c2c2c; }
        #voucher-generator-section #saveBtn { display: block; margin: 20px auto; padding: 12px 25px; background: linear-gradient(45deg, rgb(133, 61, 228), rgb(169, 117, 238)); color: #fff; border-radius: 12px; cursor: pointer; font-weight: bold; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 3px 8px rgba(0, 0, 0, 0.253); transition: 0.3s ease; }
        #voucher-generator-section #saveBtn:hover { background: linear-gradient(-45deg, rgb(133, 61, 228), rgb(169, 117, 238)); transform: scale(1.05); }
        #voucher-generator-section #overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: transparent; z-index: 15; display: none; }
        #voucher-generator-section .bg-controls { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
        #voucher-generator-section .bg-control-btn { background: linear-gradient(45deg, #6c757d, #adb5bd); color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; border: 1px solid rgba(255, 255, 255, 0.2); }
        #voucher-generator-section #folderSystem { margin: 20px 0; display: none; }
        #voucher-generator-section #folderSystem.visible { display: block; }
        #voucher-generator-section #folderControls { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px; }
        #voucher-generator-section #createFolderBtn, #voucher-generator-section #actionFolderBtn { background: linear-gradient(45deg, rgb(133, 61, 228), rgb(169, 117, 238)); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.253); font-weight: bold; border: 1px solid rgba(255, 255, 255, 0.2); transition: 0.3s ease; }
        #voucher-generator-section #createFolderBtn:hover, #voucher-generator-section #actionFolderBtn:hover { background: linear-gradient(-45deg, rgb(133, 61, 228), rgb(169, 117, 238)); transform: scale(1.02); }
        #voucher-generator-section #backToFoldersBtn { background: linear-gradient(45deg, #666, #999); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid rgba(255, 255, 255, 0.2); transition: 0.3s ease; display: none; }
        #voucher-generator-section #backToFoldersBtn:hover { background: linear-gradient(-45deg, #666, #999); transform: scale(1.02); }
        #voucher-generator-section #folderList { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        #voucher-generator-section .folder { background: rgba(255, 255, 255, 0.8); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); }
        #voucher-generator-section .folder:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.9); }
        #voucher-generator-section .folder-icon { font-size: 40px; color: rgba(104, 0, 241, 0.753); margin-bottom: 10px; }
        #voucher-generator-section .folder-name { font-weight: bold; color: #3A3A3A; word-break: break-word; }
        #voucher-generator-section .folder-checkbox { position: absolute; top: 10px; left: 10px; display: none; }
        #voucher-generator-section #folderList.selection-mode .folder-checkbox { display: block; }
        #voucher-generator-section #folderList.selection-mode .folder { opacity: 0.7; }
        #voucher-generator-section #folderList.selection-mode .folder.selected { opacity: 1; border: 2px solid rgba(104, 0, 241, 0.753); }
        #voucher-generator-section #folderFormContainer { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2), 0 0 15px rgba(104, 0, 241, 0.3); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.3); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 35; width: 300px; }
        #voucher-generator-section #folderFormContainer.visible { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        #voucher-generator-section #folderForm { display: flex; flex-direction: column; gap: 12px; }
        #voucher-generator-section #folderForm button[type="submit"] { background: linear-gradient(45deg, rgb(133, 61, 228), rgb(169, 117, 238)); color: white; padding: 10px; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.253); border: 1px solid rgba(255, 255, 255, 0.2); transition: 0.3s ease; }
        #voucher-generator-section #folderCloseFormBtn { position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.1); border: none; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #555; font-weight: bold; transition: 0.3s ease; }
        #voucher-generator-section #folderActionIsland { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 10px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2), 0 0 15px rgba(104, 0, 241, 0.3); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.3); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 30; display: flex; gap: 10px; }
        #voucher-generator-section #folderActionIsland.visible { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        #voucher-generator-section #voucherSystem { display: none; }
        #voucher-generator-section #voucherSystem.visible { display: block; }
        #voucher-generator-section #closeVoucherSystemBtn { position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.1); border: none; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #353535; font-weight: bold; transition: 0.3s ease; }
        #voucher-generator-section #folderConfirmDialog, #voucher-generator-section #itemConfirmDialog, #voucher-generator-section #saveOptionsDialog { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2); z-index: 35; text-align: center; width: 320px; }
        #voucher-generator-section #folderConfirmDialog p, #voucher-generator-section #itemConfirmDialog p, #voucher-generator-section #saveOptionsDialog p { color: #242424; margin-bottom: 20px; }
        #voucher-generator-section .dialog-buttons { display: flex; gap: 10px; justify-content: center; }
        #voucher-generator-section .dialog-buttons button { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; color: white; font-weight: bold; }
        #voucher-generator-section .confirm-btn { background: linear-gradient(45deg, rgb(218, 71, 103), rgb(240, 131, 154)); }
        #voucher-generator-section .cancel-btn { background:linear-gradient(45deg,  rgb(133, 61, 228), rgb(169, 117, 238)); }
        #voucher-generator-section .save-jpg-btn, #voucher-generator-section .save-png-btn { background: linear-gradient(45deg,  rgb(133, 61, 228), rgb(169, 117, 238)); }
        #voucher-generator-section .share-btn { background: linear-gradient(45deg, #25d366, #34b7f1); }
        
        /* --- SECTION 2: DRESS ORDER RECORDS STYLES --- */
        #dress-order-section { --primary-color: rgba(104, 0, 241, 0.753); --primary-gradient: linear-gradient(45deg, rgb(133, 61, 228), rgb(169, 117, 238)); --delete-gradient: linear-gradient(45deg, #ef5350, #e57373); }
        #dress-order-section .container { max-width: 700px; margin: 20px auto; padding: 20px; background: rgba(255, 255, 255, 0.692); border-radius: 15px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); position: relative; }
        #dress-order-section h1, #dress-order-section h2, #dress-order-section h3 { text-align: center; color: var(--primary-color); text-shadow: 0 0 8px #ffffffa4; }
        #dress-order-section h1 { margin-bottom: 25px; }
        #dress-order-section h2 { margin-bottom: 10px; margin-top: 15px; font-size: 1.2em; }
        #dress-order-section h3 { font-size: 1.1em; margin-top: 20px; margin-bottom: 10px; text-align: left; }
        #dress-order-section .footer-credit { text-align: center; font-size: 10px; color: rgba(56, 43, 43, 0.5); margin-top: 15px; font-weight: bold; }
        #dress-order-section #overlay, #dress-order-section #imageEditorOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 15; display: none; backdrop-filter: blur(4px); }
        #dress-order-section #imageEditorOverlay { z-index: 45; background: rgba(0,0,0,0.6); }
        #dress-order-section #orderSystem { display: block; }
        #dress-order-section #orderControls { display: flex; justify-content: space-between; margin-bottom: 15px; gap: 10px; }
        #dress-order-section #createOrderBtn, #dress-order-section #actionOrderBtn, #dress-order-section #backToOrdersBtn, #dress-order-section #cancelSelectionBtn, #dress-order-section .app-button { background: var(--primary-gradient); color: white; padding: 8px 15px; border-radius: 8px; cursor: pointer; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.253); font-weight: bold; border: 1px solid rgba(255, 255, 255, 0.2); transition: 0.3s ease; text-align: center; }
        #dress-order-section #backToOrdersBtn, #dress-order-section #cancelSelectionBtn { background: linear-gradient(45deg, #666, #999); }
        #dress-order-section #cancelSelectionBtn { display: none; }
        #dress-order-section #orderList { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        #dress-order-section .order-item { background: rgba(255, 255, 255, 0.8); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; position: relative; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); }
        #dress-order-section .order-item:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        #dress-order-section .order-icon { font-size: 40px; color: var(--primary-color); margin-bottom: 10px; }
        #dress-order-section .order-name { font-weight: bold; color: #3A3A3A; word-break: break-word; }
        #dress-order-section .order-status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 5px; color: white; margin-top: 8px; display: inline-block; }
        #dress-order-section .status-pending { background-color: #42a5f5; }
        #dress-order-section .status-in-progress { background-color: #ef5350; }
        #dress-order-section .status-completed { background-color: rgb(133, 61, 228); }
        #dress-order-section .order-checkbox { position: absolute; top: 10px; left: 10px; display: none; width: 18px; height: 18px; }
        #dress-order-section #orderList.selection-mode .order-checkbox { display: block; }
        #dress-order-section #orderList.selection-mode .order-item { opacity: 0.7; }
        #dress-order-section #orderList.selection-mode .order-item.selected { opacity: 1; border: 2px solid var(--primary-color); }
        #dress-order-section #orderFormContainer, #dress-order-section #orderActionIsland { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2), 0 0 15px rgba(104, 0, 241, 0.3); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.3); opacity: 0; transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 35; width: 300px; }
        #dress-order-section #orderFormContainer.visible, #dress-order-section #orderActionIsland.visible { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        #dress-order-section #orderActionIsland { display: flex; gap: 10px; padding: 10px; z-index: 30; }
        #dress-order-section #orderForm { display: flex; flex-direction: column; gap: 12px; }
        #dress-order-section #orderForm input { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: rgba(255, 255, 255, 0.7); }
        #dress-order-section #orderForm button { background: var(--primary-gradient); color: white; padding: 10px; border-radius: 12px; cursor: pointer; font-weight: bold; border: none; }
        #dress-order-section .action-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; color: white; font-size: 18px; }
        #dress-order-section .action-icon.delete-icon { background: var(--delete-gradient); }
        #dress-order-section #orderDetailView { display: none; position: relative; }
        #dress-order-section .close-btn { position: absolute; top: -10px; right: -5px; width: 30px; height: 30px; border-radius: 50%; border: none; background: rgba(0,0,0,0.1); color: #333; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; transition: all 0.2s ease; z-index: 5; }
        #dress-order-section .close-btn:hover { background: rgba(0,0,0,0.2); transform: scale(1.1); }
        #dress-order-section #detailContainer { background: rgba(255, 255, 255, 0.897); border-radius: 10px; padding: 20px; margin-top: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #dress-order-section #orderDetailForm .form-group { margin-bottom: 15px; }
        #dress-order-section #orderDetailForm label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        #dress-order-section #orderDetailForm input, #dress-order-section #orderDetailForm textarea, #dress-order-section #orderDetailForm select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: rgba(255, 255, 255, 0.9); font-size: 1em; }
        #dress-order-section #orderDetailForm textarea { resize: vertical; min-height: 400px; }
        #dress-order-section .album-container { margin-top: 15px; }
        #dress-order-section .album-header { display: flex; justify-content: space-between; align-items: center; }
        #dress-order-section .add-photo-btn { font-size: 0.9em; padding: 6px 12px; }
        #dress-order-section .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 8px; min-height: 110px; }
        #dress-order-section .album-thumbnail { position: relative; width: 100%; padding-top: 100%; border-radius: 8px; overflow: hidden; cursor: pointer; background-color: #eee; }
        #dress-order-section .album-thumbnail img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
        #dress-order-section .album-thumbnail:hover img { transform: scale(1.1); }
        #dress-order-section .thumb-delete-btn { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; border-radius: 50%; background: var(--delete-gradient); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; opacity: 0; transition: opacity 0.3s ease; z-index: 2; }
        #dress-order-section .album-thumbnail:hover .thumb-delete-btn { opacity: 1; }
        #dress-order-section #imageEditor { position: fixed; top: 0; left: 0; width: 100%; height: 100%; transform: scale(0); background: #f0f0f0; border-radius: 0; z-index: 50; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0; }
        #dress-order-section #imageEditor.visible { transform: scale(1); opacity: 1; }
        #dress-order-section .editor-header { padding: 10px 15px; background: #fff; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; align-items: stretch; flex-shrink: 0; }
        #dress-order-section .editor-header-main { display: flex; justify-content: space-between; align-items: center; }
        #dress-order-section .editor-title { color: #333; font-size: 1.1em; text-shadow: none; text-align: left; }
        #dress-order-section .editor-close-btn { font-size: 24px; color: #555; cursor: pointer; background: none; border: none; }
        #dress-order-section #imageMetadataDisplay { font-size: 0.75em; color: #555; background-color: #f0f0f0; padding: 8px; border-radius: 5px; margin-top: 8px; line-height: 1.4; border: 1px solid #ddd; }
        #dress-order-section .editor-canvas-container { flex-grow: 1; position: relative; background-color: #333; overflow: hidden; touch-action: none; }
        #dress-order-section #editorCanvas { position: absolute; top: 0; left: 0; cursor: grab; }
        #dress-order-section #editorCanvas:active { cursor: grabbing; }
        #dress-order-section #editorCanvas.doodle-mode { cursor: crosshair; }
        .editor-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 22px;
            cursor: pointer;
            z-index: 10;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.2s ease;
            text-shadow: 0 0 5px black;
        }
        .editor-nav-btn:hover { background: rgba(0, 0, 0, 0.7); }
        .editor-nav-btn.prev { left: 15px; }
        .editor-nav-btn.next { right: 15px; }
        #dress-order-section .editor-toolbar { padding: 10px; background: #fff; border-top: 1px solid #ddd; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; flex-shrink: 0; }
        #dress-order-section .editor-toolbar button { padding: 8px 12px; font-size: 0.9em; }
        #dress-order-section .editor-toolbar .delete-btn { background: var(--delete-gradient); }
        #dress-order-section .color-palette { display: flex; align-items: center; gap: 8px; padding: 0 5px; border-left: 1px solid #ddd; border-right: 1px solid #ddd; margin: 0 5px; }
        #dress-order-section .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        #dress-order-section .color-swatch:hover { transform: scale(1.1); }
        #dress-order-section .color-swatch.selected { border-color: #007bff; transform: scale(1.15); }
        #dress-order-section .color-swatch[data-color='white'] { border: 1px solid #ccc; }
        #dress-order-section #textEditorUI { position: absolute; border: 2px dashed #007bff; display: none; cursor: move; z-index: 10; }
        #dress-order-section #textEditorInput { width: 100%; height: 100%; padding: 0; margin: 0; background: rgba(255, 255, 255, 0.1); color: inherit; border: none; outline: none; resize: none; text-align: center; -webkit-text-fill-color: inherit; }
        #dress-order-section .text-handle { position: absolute; width: 12px; height: 12px; background-color: #007bff; border: 1px solid white; border-radius: 50%; z-index: 11; }
        #dress-order-section #text-resize-handle { bottom: -6px; right: -6px; cursor: nwse-resize; }
        #dress-order-section #text-rotate-handle { top: -15px; left: calc(50% - 6px); cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 11.857 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/></svg>') 8 8, auto; }
        #dress-order-section #text-delete-handle { top: -6px; right: -6px; cursor: pointer; background-color: #ef5350; }
        #dress-order-section #orderConfirmDialog { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2); z-index: 40; text-align: center; width: 300px; }
        #dress-order-section #orderConfirmDialog p { color: #242424; margin-bottom: 20px; font-size: 1.1em; }
        #dress-order-section .dialog-buttons { display: flex; gap: 10px; justify-content: center; }
        #dress-order-section .dialog-buttons button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; color: white; font-weight: bold; flex-grow: 1; }
        #dress-order-section .confirm-btn { background: #ef5350; }
        #dress-order-section .cancel-btn { background: #64b5f6; }

        /* --- SECTION 3: CALENDAR STYLES --- */
        #calendar-section .container {
             max-width: 800px; margin: 20px auto; padding: 20px;
             background: rgba(255, 255, 255, 0.692); border-radius: 15px;
             box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); backdrop-filter: blur(20px);
             border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #calendar-section h1 {
            text-align: center; color: rgba(104, 0, 241, 0.753);
            text-shadow: 0 0 8px #ffffffa4; margin-bottom: 20px;
        }
        #calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        #calendar-header button {
            background: rgba(104, 0, 241, 0.753); color: white; border: none;
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 1.2em;
        }
        #month-year-display {
            font-size: 1.5em; font-weight: bold; color: #3A3A3A;
        }
        .weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; font-weight: bold; color: rgba(104, 0, 241, 0.8);
            margin-bottom: 10px;
        }
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            padding: 10px 5px;
            text-align: center;
            min-height: 80px;
            position: relative;
            transition: background 0.2s, transform 0.2s;
        }
        .calendar-day.empty {
            background: transparent;
        }
        .calendar-day.today {
            background: rgba(169, 117, 238, 0.5);
            font-weight: bold;
            border: 2px solid rgba(104, 0, 241, 0.6);
        }
        .day-number {
            font-size: 1.1em;
        }
        .calendar-day.event-day {
            background: rgba(40, 167, 69, 0.5); /* Greenish background */
            color: #145520;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid rgba(34, 139, 34, 0.7);
        }
        .calendar-day.event-day:hover {
            background: rgba(40, 167, 69, 0.7);
            transform: scale(1.05);
        }

        /* CALENDAR MODAL STYLES */
        #calendar-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 105;
            display: none;
        }
        #calendar-deadline-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.25);
            z-index: 110;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: left;
        }
        #calendar-deadline-modal h3 {
            color: rgba(104, 0, 241, 0.85);
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
        }
        #deadline-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            max-height: 60vh;
            overflow-y: auto;
        }
        #deadline-list li {
            background: rgba(104, 0, 241, 0.08);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            color: #3A3A3A;
            font-weight: 500;
            border-left: 4px solid rgba(104, 0, 241, 0.5);
        }
        #calendar-modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            background: rgba(0,0,0,0.1);
            color: #333;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.2s ease;
        }
        #calendar-modal-close-btn:hover {
            background: rgba(0,0,0,0.2);
            transform: scale(1.1);
        }

        /* --- MEDIA QUERIES FOR RESPONSIVENESS --- */
        @media (max-width: 600px) {
            .app-section { padding: 5px; }
            #voucher-generator-section .container, #dress-order-section .container, #calendar-section .container { padding: 15px; margin: 0; width: 100%; max-width: 100%; border-radius: 0; }
            #voucher-generator-section table, #dress-order-section #orderList { font-size: 12px; }
            #dress-order-section #orderList { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            #voucher-generator-section .item-name-dropdown { width: 200px; }
        }
    </style>
 </head>
 <body> <!-- SECTION 1: VOUCHER GENERATOR -->
  <div id="voucher-generator-section" class="app-section">
   <div class="container">
    <h1>Voucher Generator</h1>
    <br>
    <br>
    <div id="overlay"></div>
    <div id="folderSystem" class="visible">
     <div id="folderControls"> <button id="createFolderBtn">Create folder</button> <button id="actionFolderBtn">Actions</button> <button id="backToFoldersBtn" style="display: none;">Back to Folders</button>
     </div>
     <div id="folderList"></div>
    </div>
    <div id="folderFormContainer">
     <form id="folderForm">
      <input type="text" id="folderName" placeholder="Folder Name" required> <button type="submit" id="folderFormSubmitBtn">Create</button>
     </form>
    </div>
    <div id="folderActionIsland">
     <div class="action-icon edit-icon" id="folderIslandEditBtn" title="Edit">
      üñãÔ∏è
     </div>
     <div class="action-icon delete-icon" id="folderIslandDeleteBtn" title="Delete">
      üóëÔ∏è
     </div>
    </div>
    <div id="folderConfirmDialog">
     <p>Are you sure you want to delete?</p>
     <div class="dialog-buttons"> <button id="confirmFolderDelete" class="confirm-btn">Delete</button> <button id="cancelFolderDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
    <div id="voucherSystem"> <button id="closeVoucherSystemBtn">√ó</button>
     <form id="detailsForm">
      <input type="text" id="recipientName" placeholder="Recipient's Name" required>
      <input type="date" id="voucherDate" required>
     </form>
     <div id="addColumnContainer"> <button id="addColumnBtn">Columns</button>
      <div id="columnOptions">
       <div class="column-option" data-columns="5">
        5 Columns
       </div>
       <div class="column-option" data-columns="10">
        10 Columns
       </div>
       <div class="column-option" data-columns="15">
        15 Columns
       </div>
       <div class="column-option" data-columns="20">
        20 Columns
       </div>
       <div class="column-option" data-columns="25">
        25 Columns
       </div>
      </div>
     </div>
     <div id="dynamicIsland">
      <div class="action-icon delete-icon" id="islandDeleteBtn" title="Delete">
       üóëÔ∏è
      </div>
      <div class="action-icon save-icon" id="islandSaveBtn" title="Save Options">
       üíæ
      </div>
     </div>
     <div id="voucher">
      <h1 style="font-family:helvetica">Maybal</h1>
      <div class="voucher-header">
       <p id="displayRecipientName"></p>
       <p id="displayVoucherDate"></p>
      </div>
      <div style="overflow-x: auto;">
       <table id="voucherTable">
        <thead>
         <tr>
          <th>Item Name</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
         </tr>
        </thead>
        <tbody></tbody>
       </table>
      </div>
      <h3 id="grandTotal">Grand Total: 0 ·ÄÄ·Äª·Äï·Ä∫</h3>
      <div class="aaa">
       ¬©Ô∏èAung Kaung Myat production
      </div>
     </div>
     <div class="bg-controls">
        <input type="file" id="bgUploader" accept="image/*" style="display: none;">
        <button id="uploadBgBtn" class="bg-control-btn">Upload Background</button>
        <button id="removeBgBtn" class="bg-control-btn">Remove Background</button>
    </div>
    <button id="saveBtn">Save Voucher</button>
    </div>
    <div id="itemConfirmDialog">
     <p>Are you sure you want to delete?</p>
     <div class="dialog-buttons"> <button id="confirmItemDelete" class="confirm-btn">Delete</button> <button id="cancelItemDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
    <div id="saveOptionsDialog">
     <p>Choose save format:</p>
     <div class="dialog-buttons"> <button id="saveAsJpg" class="save-jpg-btn">Save as JPG</button> <button id="saveAsPng" class="save-png-btn">Save as PNG</button> <button id="shareVoucherBtn" class="share-btn">Share</button>
     </div>
    </div>
   </div>
  </div> <!-- SECTION 2: DRESS ORDER RECORDS -->
  <div id="dress-order-section" class="app-section">
   <div class="container">
    <h1>Dress Order Records</h1>
    <div id="overlay"></div>
    <div id="imageEditorOverlay"></div>
    <div id="orderSystem">
     <div id="orderControls"> <button id="createOrderBtn">New Order</button> <button id="actionOrderBtn">Actions</button> <button id="cancelSelectionBtn">Cancel</button> <button id="backToOrdersBtn" style="display:none">Back</button>
     </div>
     <div id="orderList"></div>
    </div>
    <div id="orderFormContainer">
     <form id="orderForm">
      <input type="text" id="orderNameInput" placeholder="Order Name (e.g., Customer's Name)" required> <button type="submit" id="orderFormSubmitBtn">Create</button>
     </form>
    </div>
    <div id="orderActionIsland">
     <div class="action-icon delete-icon" id="orderIslandDeleteBtn" title="Delete Order">
      üóëÔ∏è
     </div>
    </div>
    <div id="orderConfirmDialog">
     <p>Are you sure you want to delete the selected order(s)?</p>
     <div class="dialog-buttons"> <button id="confirmOrderDelete" class="confirm-btn">Delete</button> <button id="cancelOrderDelete" class="cancel-btn">Cancel</button>
     </div>
    </div>
    <div id="orderDetailView"> <button id="closeDetailViewBtn" class="close-btn" title="Close">√ó</button>
     <div id="detailContainer">
      <h2 id="displayOrderName"></h2>
      <form id="orderDetailForm">
       <div class="form-group"> <label for="customerName">Customer Name</label>
        <input type="text" id="customerName" placeholder="Enter customer's name">
       </div>
       <div class="form-group"> <label for="orderStatus">Status</label> <select id="orderStatus"><option value="pending">Pending</option><option value="in-progress">In Progress</option><option value="completed">Completed</option></select>
       </div>
       <div class="form-group"> <label for="fittingDate">Fitting Date</label>
        <input type="date" id="fittingDate">
       </div>
       <div class="form-group"> <label for="orderNotes">Notes</label> <textarea id="orderNotes" placeholder="Special requests, measurements, etc."></textarea>
       </div>
       <input type="file" id="imageUploader" accept="image/*" multiple style="display: none;">
       <div class="album-container">
        <div class="album-header">
         <h3>Fabric Album</h3><button type="button" class="app-button add-photo-btn" data-album-type="fabric">Add Photo</button>
        </div>
        <div id="fabricAlbumGrid" class="album-grid"></div>
       </div>
       <div class="album-container">
        <div class="album-header">
         <h3>Design Album</h3><button type="button" class="app-button add-photo-btn" data-album-type="design">Add Photo</button>
        </div>
        <div id="designAlbumGrid" class="album-grid"></div>
       </div>
      </form>
     </div>
     <div class="footer-credit">
       ¬©Ô∏è Aung Kaung Myat Production
     </div>
    </div>
   </div>
   <div id="imageEditor">
    <div class="editor-header">
     <div class="editor-header-main">
      <h2 class="editor-title">Image Editor</h2><button id="editorCloseBtn" class="editor-close-btn">√ó</button>
     </div>
     <div id="imageMetadataDisplay"></div>
    </div>
    <div class="editor-canvas-container">
     <canvas id="editorCanvas"></canvas> <button id="prevImageBtn" class="editor-nav-btn prev">‚óÄÔ∏è</button> <button id="nextImageBtn" class="editor-nav-btn next">‚ñ∂Ô∏è</button>
     <div id="textEditorUI"> <textarea id="textEditorInput"></textarea>
      <div id="text-resize-handle" class="text-handle"></div>
      <div id="text-rotate-handle" class="text-handle"></div>
      <div id="text-delete-handle" class="text-handle"></div>
     </div>
    </div>
    <div class="editor-toolbar"> <button id="addTextBtn" class="app-button">Enter Text</button> <button id="doodleBtn" class="app-button">Doodle</button>
     <div id="colorPalette" class="color-palette">
      <div class="color-swatch selected" data-color="red" style="background-color: red;" title="Red"></div>
      <div class="color-swatch" data-color="blue" style="background-color: blue;" title="Blue"></div>
      <div class="color-swatch" data-color="yellow" style="background-color: yellow;" title="Yellow"></div>
      <div class="color-swatch" data-color="white" style="background-color: white;" title="White"></div>
     </div> <button id="saveCanvasBtn" class="app-button">Save Changes</button> <button id="deleteImageBtn" class="app-button delete-btn">Delete Image</button>
    </div>
   </div>
  </div> <!-- SECTION 3: CALENDAR -->
  <div id="calendar-section" class="app-section">
   <div class="container">
    <h1>Fitting Calendar</h1>
    <div id="calendar-header"> <button id="prev-month-btn">&lt;</button>
     <h2 id="month-year-display"></h2> <button id="next-month-btn">&gt;</button>
    </div>
    <div class="weekdays">
     <div>
      Sun
     </div>
     <div>
      Mon
     </div>
     <div>
      Tue
     </div>
     <div>
      Wed
     </div>
     <div>
      Thu
     </div>
     <div>
      Fri
     </div>
     <div>
      Sat
     </div>
    </div>
    <div id="calendar-grid"></div>
   </div>
  </div>
  <!-- CALENDAR MODAL -->
  <div id="calendar-modal-overlay"></div>
  <div id="calendar-deadline-modal"> <button id="calendar-modal-close-btn">√ó</button>
   <h3>Fittings for this Day</h3>
   <ul id="deadline-list">
    <!-- Content will be injected by JS -->
   </ul>
  </div>
  <!-- FOOTER NAVIGATION MENU -->
  <nav id="footer-menu">
   <div class="menu-item active" data-target="#voucher-generator-section"> <i class="fa-solid fa-receipt"></i> <span>Voucher</span>
   </div>
   <div class="menu-item" data-target="#dress-order-section"> <i class="fa-solid fa-shirt"></i> <span>Orders</span>
   </div>
   <div class="menu-item" data-target="#calendar-section"> <i class="fa-solid fa-calendar-days"></i> <span>Calendar</span>
   </div>
  </nav>
  <script>
    // --- WRAPPER FOR VOUCHER GENERATOR SCRIPT ---
    (function() {
        // All variables and functions from mbvg.html are scoped within this IIFE
        const section = document.querySelector('#voucher-generator-section');
        if (!section) return;

        const addColumnBtn = section.querySelector('#addColumnBtn');
        const columnOptions = section.querySelector('#columnOptions');
        const overlay = section.querySelector('#overlay');
        const dynamicIsland = section.querySelector('#dynamicIsland');
        const islandDeleteBtn = section.querySelector('#islandDeleteBtn');
        const islandSaveBtn = section.querySelector('#islandSaveBtn');
        const recipientNameInput = section.querySelector('#recipientName');
        const voucherDateInput = section.querySelector('#voucherDate');
        const saveBtn = section.querySelector('#saveBtn');
        const folderSystem = section.querySelector('#folderSystem');
        const voucherSystem = section.querySelector('#voucherSystem');
        const createFolderBtn = section.querySelector('#createFolderBtn');
        const actionFolderBtn = section.querySelector('#actionFolderBtn');
        const backToFoldersBtn = section.querySelector('#backToFoldersBtn');
        const folderList = section.querySelector('#folderList');
        const folderFormContainer = section.querySelector('#folderFormContainer');
        const folderForm = section.querySelector('#folderForm');
        const folderFormSubmitBtn = section.querySelector('#folderFormSubmitBtn');
        const folderActionIsland = section.querySelector('#folderActionIsland');
        const folderIslandEditBtn = section.querySelector('#folderIslandEditBtn');
        const folderIslandDeleteBtn = section.querySelector('#folderIslandDeleteBtn');
        const closeVoucherSystemBtn = section.querySelector('#closeVoucherSystemBtn');
        const folderConfirmDialog = section.querySelector('#folderConfirmDialog');
        const confirmFolderDelete = section.querySelector('#confirmFolderDelete');
        const cancelFolderDelete = section.querySelector('#cancelFolderDelete');
        const itemConfirmDialog = section.querySelector('#itemConfirmDialog');
        const confirmItemDelete = section.querySelector('#confirmItemDelete');
        const cancelItemDelete = section.querySelector('#cancelItemDelete');
        const saveOptionsDialog = section.querySelector('#saveOptionsDialog');
        const saveAsJpg = section.querySelector('#saveAsJpg');
        const saveAsPng = section.querySelector('#saveAsPng');
        const shareVoucherBtn = section.querySelector('#shareVoucherBtn');
        const bgUploader = section.querySelector('#bgUploader');
        const uploadBgBtn = section.querySelector('#uploadBgBtn');
        const removeBgBtn = section.querySelector('#removeBgBtn');
        const voucherElement = section.querySelector('#voucher');


        let selectedRow = null; let editIndex = null; let selectedFolder = null;
        let editFolderIndex = null; let currentFolderId = null; let isSelectionMode = false;
        let selectedFolders = [];

        const predefinedItems = ["·ÄÄ·Ä±·Ä¨·Ä∫·Äï·Ä≠·Äê·Ä∫", "·ÄÄ·ÄÅ·Äª·ÄÑ·Ä∫one set", "·Äá·Ä¨one set", "·Äï·Ä´·Äê·Ä≠·Äê·Ä∫one set", "·ÄÖ·ÄÆ·Ä∏·ÄÄ·ÄΩ·ÄÑ·Ä∑·Ä∫", "Hand Made", "·ÄÅ·Äª·Ä≠·Äê·Ä∫·Äë·Äô·ÄÆ", "·Äï·Äê·Ä∫·Äë·Äô·ÄÆ", "No Bra", "·ÄÇ·Ä´·Äù·Äî·Ä∫", "·Äî·Äæ·ÄÖ·Ä∫·Äë·Äï·Ä∫·ÄÅ·Äª·ÄØ·Äï·Ä∫", "·Äõ·ÄÑ·Ä∫·Äñ·ÄØ·Äî·Ä∫·Ä∏", "·Äî·Ä±·Ä¨·ÄÄ·Ä∫·Äá·ÄÖ·Ä∫"];

        loadFolders();

        function loadFolders() {
            const folders = JSON.parse(localStorage.getItem('folders')) || [];
            folderList.innerHTML = '';
            if (folders.length === 0) {
                folderList.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">No folders created yet</p>';
            } else {
                folders.forEach((folder, index) => {
                    const folderElement = document.createElement('div');
                    folderElement.className = 'folder';
                    folderElement.dataset.folderId = folder.id;
                    folderElement.innerHTML = `<input type="checkbox" class="folder-checkbox" data-folder-id="${folder.id}"><div class="folder-icon">üìÅ</div><div class="folder-name">${folder.name}</div>`;
                    folderElement.addEventListener('click', (e) => {
                        if (isSelectionMode) { e.preventDefault(); const checkbox = folderElement.querySelector('.folder-checkbox'); checkbox.checked = !checkbox.checked; toggleFolderSelection(folder.id, index); } else { openFolder(folder.id); }
                    });
                    folderList.appendChild(folderElement);
                });
            }
        }
        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode; selectedFolders = [];
            folderList.classList.toggle('selection-mode', isSelectionMode);
            actionFolderBtn.textContent = isSelectionMode ? 'Done' : 'Actions';
            const checkboxes = section.querySelectorAll('.folder-checkbox');
            checkboxes.forEach(checkbox => { checkbox.checked = false; });
            if (!isSelectionMode) { hideFolderActionIsland(); }
        }
        function toggleFolderSelection(folderId, index) {
            const folderElement = section.querySelector(`.folder[data-folder-id="${folderId}"]`);
            const isSelected = selectedFolders.some(f => f.id === folderId);
            if (isSelected) { selectedFolders = selectedFolders.filter(f => f.id !== folderId); folderElement.classList.remove('selected'); } else { const folders = JSON.parse(localStorage.getItem('folders')) || []; selectedFolders.push({ id: folderId, index, name: folders[index].name }); folderElement.classList.add('selected'); }
            if (selectedFolders.length > 0) { showFolderActionIsland(); } else { hideFolderActionIsland(); }
        }
        function openFolder(folderId) {
            currentFolderId = folderId;
            folderSystem.classList.remove('visible');
            voucherSystem.classList.add('visible');
            backToFoldersBtn.style.display = 'block';
            loadVoucherData(folderId);
        }
        function closeFolder() {
            currentFolderId = null;
            folderSystem.classList.add('visible');
            voucherSystem.classList.remove('visible');
            backToFoldersBtn.style.display = 'none';
            saveVoucherData();
            if (isSelectionMode) { toggleSelectionMode(); }
        }
        function showFolderForm(isEdit = false, folder = null) {
            folderFormContainer.classList.add('visible');
            overlay.style.display = 'block';
            folderFormSubmitBtn.textContent = isEdit ? 'Update Folder' : 'Create Folder';
            if (isEdit && folder) { section.querySelector('#folderName').value = folder.name; } else { section.querySelector('#folderName').value = ''; }
        }
        function closeFolderForm() {
            folderFormContainer.classList.remove('visible');
            overlay.style.display = 'none';
            folderForm.reset(); editFolderIndex = null; hideFolderActionIsland();
        }
        function showFolderActionIsland() { folderActionIsland.classList.add('visible'); overlay.style.display = 'block'; }
        function hideFolderActionIsland() { folderActionIsland.classList.remove('visible'); overlay.style.display = 'none'; selectedFolders = []; const folders = section.querySelectorAll('.folder'); folders.forEach(folder => folder.classList.remove('selected')); const checkboxes = section.querySelectorAll('.folder-checkbox'); checkboxes.forEach(checkbox => checkbox.checked = false); }
        folderForm.addEventListener('submit', e => {
            e.preventDefault();
            const name = section.querySelector('#folderName').value.trim();
            const folders = JSON.parse(localStorage.getItem('folders')) || [];
            if (name === '') { alert('Folder name cannot be empty'); return; }
            if (folders.some(f => f.name === name && f.id !== (editFolderIndex !== null ? folders[editFolderIndex].id : null))) { alert('Folder name already exists'); return; }
            if (editFolderIndex !== null) { folders[editFolderIndex].name = name; } else { const newFolder = { id: Date.now().toString(), name: name, voucherData: { recipientName: '', voucherDate: '', items: [], backgroundImage: null } }; folders.push(newFolder); }
            localStorage.setItem('folders', JSON.stringify(folders));
            closeFolderForm(); loadFolders();
            if (isSelectionMode) { toggleSelectionMode(); }
        });
        folderIslandEditBtn.addEventListener('click', () => { if (selectedFolders.length === 1) { editFolderIndex = selectedFolders[0].index; showFolderForm(true, { name: selectedFolders[0].name }); toggleSelectionMode(); } else { alert('Please select exactly one folder to edit.'); } });
        folderIslandDeleteBtn.addEventListener('click', () => { if (selectedFolders.length > 0) { folderConfirmDialog.style.display = 'block'; overlay.style.display = 'block'; } else { alert('Please select at least one folder to delete.'); } });
        confirmFolderDelete.addEventListener('click', () => { if (selectedFolders.length > 0) { let folders = JSON.parse(localStorage.getItem('folders')) || []; selectedFolders.forEach(folder => { folders = folders.filter(f => f.id !== folder.id); }); localStorage.setItem('folders', JSON.stringify(folders)); hideFolderActionIsland(); loadFolders(); folderConfirmDialog.style.display = 'none'; overlay.style.display = 'none'; if (isSelectionMode) { toggleSelectionMode(); } } });
        cancelFolderDelete.addEventListener('click', () => { folderConfirmDialog.style.display = 'none'; overlay.style.display = 'none'; });
        actionFolderBtn.addEventListener('click', toggleSelectionMode);
        createFolderBtn.addEventListener('click', () => showFolderForm());
        backToFoldersBtn.addEventListener('click', closeFolder);
        closeVoucherSystemBtn.addEventListener('click', closeFolder);
        overlay.addEventListener('click', () => { hideDynamicIsland(); closeFolderForm(); hideFolderActionIsland(); folderConfirmDialog.style.display = 'none'; itemConfirmDialog.style.display = 'none'; saveOptionsDialog.style.display = 'none'; columnOptions.style.display = 'none'; section.querySelectorAll('.item-name-dropdown').forEach(dropdown => { dropdown.style.display = 'none'; }); if (isSelectionMode) { toggleSelectionMode(); } });
        
        function applyVoucherBackground(bgData) {
            if (bgData) {
                voucherElement.style.backgroundImage = `url(${bgData})`;
                voucherElement.classList.add('has-bg');
            } else {
                voucherElement.style.backgroundImage = 'none';
                voucherElement.classList.remove('has-bg');
            }
        }

        function loadVoucherData(folderId) {
            const folders = JSON.parse(localStorage.getItem('folders')) || [];
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;
            const voucherData = folder.voucherData || { recipientName: '', voucherDate: '', items: [], backgroundImage: null };
            recipientNameInput.value = voucherData.recipientName || '';
            voucherDateInput.value = voucherData.voucherDate || '';
            section.querySelector('#displayRecipientName').textContent = voucherData.recipientName || '';
            section.querySelector('#displayVoucherDate').textContent = voucherData.voucherDate || '';
            applyVoucherBackground(voucherData.backgroundImage);
            const tableBody = section.querySelector('#voucherTable tbody');
            tableBody.innerHTML = '';
            if (!voucherData.items || voucherData.items.length === 0) { addItemToTable('', 0, 0); } else { voucherData.items.forEach(item => { addItemToTable(item.name || '', item.quantity || 0, item.price || 0); }); }
            updateGrandTotal();
        }

        function saveVoucherData() {
            if (!currentFolderId) return;
            const items = [];
            section.querySelectorAll('#voucherTable tbody tr').forEach(row => { const name = row.querySelector('.item-name input').value.trim(); const quantity = row.querySelector('.quantity input').value.trim(); const price = row.querySelector('.price input').value.trim(); items.push({ name: name || '', quantity: quantity ? parseInt(quantity) : 0, price: price ? parseFloat(price) : 0 }); });
            const folders = JSON.parse(localStorage.getItem('folders')) || [];
            const folderIndex = folders.findIndex(f => f.id === currentFolderId);
            if (folderIndex !== -1) {
                const currentBg = folders[folderIndex].voucherData ? folders[folderIndex].voucherData.backgroundImage : null;
                const voucherData = { recipientName: recipientNameInput.value, voucherDate: voucherDateInput.value, items, backgroundImage: currentBg };
                folders[folderIndex].voucherData = voucherData; 
                localStorage.setItem('folders', JSON.stringify(folders)); 
            }
        }

        uploadBgBtn.addEventListener('click', () => bgUploader.click());

        bgUploader.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const bgData = e.target.result;
                applyVoucherBackground(bgData);
                // Save to localStorage
                const folders = JSON.parse(localStorage.getItem('folders')) || [];
                const folderIndex = folders.findIndex(f => f.id === currentFolderId);
                if(folderIndex !== -1) {
                    if(!folders[folderIndex].voucherData) folders[folderIndex].voucherData = {};
                    folders[folderIndex].voucherData.backgroundImage = bgData;
                    localStorage.setItem('folders', JSON.stringify(folders));
                }
            };
            reader.readAsDataURL(file);
        });

        removeBgBtn.addEventListener('click', () => {
             applyVoucherBackground(null);
             // Remove from localStorage
             const folders = JSON.parse(localStorage.getItem('folders')) || [];
             const folderIndex = folders.findIndex(f => f.id === currentFolderId);
             if(folderIndex !== -1 && folders[folderIndex].voucherData) {
                 folders[folderIndex].voucherData.backgroundImage = null;
                 localStorage.setItem('folders', JSON.stringify(folders));
             }
        });

        function initDropdown(row) {
            const dropdown = row.querySelector('.item-name-dropdown');
            dropdown.innerHTML = '';
            predefinedItems.forEach(item => { const div = document.createElement('div'); div.className = 'dropdown-item'; div.textContent = item; div.addEventListener('click', (e) => { e.stopPropagation(); row.querySelector('.item-name input').value = item; dropdown.style.display = 'none'; updateRowTotal(row); updateGrandTotal(); saveVoucherData(); }); dropdown.appendChild(div); });
        }
        addColumnBtn.addEventListener('click', () => { columnOptions.style.display = columnOptions.style.display === 'block' ? 'none' : 'block'; });
        columnOptions.querySelectorAll('.column-option').forEach(option => { option.addEventListener('click', () => { const numColumns = parseInt(option.dataset.columns); addColumnsToTable(numColumns); columnOptions.style.display = 'none'; saveVoucherData(); }); });
        function addColumnsToTable(numColumns) {
            const tableBody = section.querySelector('#voucherTable tbody');
            const currentRows = tableBody.querySelectorAll('tr').length;
            const rowsToAdd = numColumns - currentRows;
            if (rowsToAdd > 0) { for (let i = 0; i < rowsToAdd; i++) { const row = document.createElement('tr'); row.innerHTML = `<td class="item-name"><div class="item-name-container"><input type="text" placeholder="Item Name"><div class="item-name-dropdown"></div></div></td><td class="quantity"><input type="number" placeholder="Qty" min="0"></td><td class="price"><input type="number" placeholder="Price" min="0"></td><td class="total">0 ·ÄÄ·Äª·Äï·Ä∫</td>`; tableBody.appendChild(row); initDropdown(row); attachInputListeners(row); row.querySelector('.item-name').addEventListener('click', (e) => { e.stopPropagation(); const rows = Array.from(section.querySelectorAll('#voucherTable tbody tr')); showDynamicIsland(row, rows.indexOf(row)); }); } }
            updateGrandTotal();
        }
        function attachInputListeners(row) {
            const itemNameInput = row.querySelector('.item-name input');
            const dropdown = row.querySelector('.item-name-dropdown');
            const inputs = row.querySelectorAll('input');
            itemNameInput.addEventListener('click', (e) => { e.stopPropagation(); initDropdown(row); section.querySelectorAll('.item-name-dropdown').forEach(d => { if (d !== dropdown) d.style.display = 'none'; }); dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block'; });
            itemNameInput.addEventListener('input', () => { const searchTerm = itemNameInput.value.toLowerCase(); const items = dropdown.querySelectorAll('.dropdown-item'); items.forEach(item => { if (item.textContent.toLowerCase().includes(searchTerm)) { item.style.display = 'block'; } else { item.style.display = 'none'; } }); updateRowTotal(row); updateGrandTotal(); saveVoucherData(); });
            document.addEventListener('click', (e) => { if (!row.contains(e.target) && !dropdown.contains(e.target)) { dropdown.style.display = 'none'; } });
            inputs.forEach(input => { if (input !== itemNameInput) { input.addEventListener('input', () => { updateRowTotal(row); updateGrandTotal(); saveVoucherData(); }); } });
        }
        function updateRowTotal(row) { const quantity = parseInt(row.querySelector('.quantity input').value) || 0; const price = parseFloat(row.querySelector('.price input').value) || 0; const total = (quantity * price).toFixed(0); row.querySelector('.total').textContent = `${total} ·ÄÄ·Äª·Äï·Ä∫`; }
        function addItemToTable(name, quantity, price) { const tableBody = section.querySelector('#voucherTable tbody'); const row = document.createElement('tr'); const total = ((quantity || 0) * (price || 0)).toFixed(0); row.innerHTML = `<td class="item-name"><div class="item-name-container"><input type="text" value="${name}" placeholder="Item Name"><div class="item-name-dropdown"></div></div></td><td class="quantity"><input type="number" value="${quantity || ''}" placeholder="Qty" min="0"></td><td class="price"><input type="number" value="${price || ''}" placeholder="Price" min="0"></td><td class="total">${total} ·ÄÄ·Äª·Äï·Ä∫</td>`; tableBody.appendChild(row); initDropdown(row); attachInputListeners(row); row.querySelector('.item-name').addEventListener('click', (e) => { e.stopPropagation(); const rows = Array.from(section.querySelectorAll('#voucherTable tbody tr')); showDynamicIsland(row, rows.indexOf(row)); }); }
        function updateGrandTotal() { const rows = section.querySelectorAll('#voucherTable tbody tr'); let grandTotal = 0; rows.forEach(row => { const total = parseFloat(row.querySelector('.total').textContent.replace(' ·ÄÄ·Äª·Äï·Ä∫', '')) || 0; grandTotal += total; }); section.querySelector('#grandTotal').textContent = `Grand Total: ${grandTotal.toFixed(0)} ·ÄÄ·Äª·Äï·Ä∫`; saveVoucherData(); }
        function showDynamicIsland(row, index) { selectedRow = row; editIndex = index; dynamicIsland.classList.add('visible'); overlay.style.display = 'block'; addColumnBtn.style.opacity = '0'; setTimeout(() => addColumnBtn.style.display = 'none', 400); }
        function hideDynamicIsland() { dynamicIsland.classList.remove('visible'); overlay.style.display = 'none'; addColumnBtn.style.display = 'block'; setTimeout(() => addColumnBtn.style.opacity = '1', 50); selectedRow = null; editIndex = null; }
        islandDeleteBtn.addEventListener('click', () => { itemConfirmDialog.style.display = 'block'; overlay.style.display = 'block'; });
        islandSaveBtn.addEventListener('click', () => { saveOptionsDialog.style.display = 'block'; overlay.style.display = 'block'; });
        confirmItemDelete.addEventListener('click', () => { if (selectedRow) { selectedRow.remove(); updateGrandTotal(); hideDynamicIsland(); itemConfirmDialog.style.display = 'none'; overlay.style.display = 'none'; saveVoucherData(); } });
        cancelItemDelete.addEventListener('click', () => { itemConfirmDialog.style.display = 'none'; overlay.style.display = 'none'; });
        saveAsJpg.addEventListener('click', () => { saveVoucherAsImage('jpg'); saveOptionsDialog.style.display = 'none'; overlay.style.display = 'none'; hideDynamicIsland(); });
        saveAsPng.addEventListener('click', () => { saveVoucherAsImage('png'); saveOptionsDialog.style.display = 'none'; overlay.style.display = 'none'; hideDynamicIsland(); });
        
        async function shareVoucher() {
            if (!navigator.share || !navigator.canShare) {
                alert('Your browser does not support the Web Share API. Please save the image and share it manually.');
                return;
            }
            const voucher = section.querySelector('#voucher');
            const recipientName = recipientNameInput.value || 'unnamed';
            const fileName = `voucher_${recipientName}_${new Date().toISOString().split('T')[0]}.png`;
            try {
                const canvas = await html2canvas(voucher, { useCORS: true, scale: window.devicePixelRatio || 2, letterRendering: true, allowTaint: true, logging: false, onclone: function(clonedDoc) { clonedDoc.body.style.fontFamily = "'Padauk', 'Myanmar Text', sans-serif"; } });
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], fileName, { type: 'image/png' });
                    const shareData = {
                        files: [file],
                        title: `Voucher for ${recipientName}`,
                        text: `Here is the voucher from Maybal.`,
                    };
                    if (navigator.canShare(shareData)) {
                        await navigator.share(shareData);
                    } else {
                        alert('Sharing this file is not supported.');
                    }
                }, 'image/png', 1.0);
            } catch (error) {
                alert('Could not share the voucher: ' + error);
            } finally {
                saveOptionsDialog.style.display = 'none';
                overlay.style.display = 'none';
                hideDynamicIsland();
            }
        }
        shareVoucherBtn.addEventListener('click', shareVoucher);

        function saveVoucherAsImage(format) { const voucher = section.querySelector('#voucher'); const options = { useCORS: true, scale: window.devicePixelRatio || 2, letterRendering: true, allowTaint: true, logging: false, onclone: function(clonedDoc) { clonedDoc.body.style.fontFamily = "'Padauk', 'Myanmar Text', sans-serif"; } }; html2canvas(voucher, options).then(canvas => { const fileName = `voucher_${recipientNameInput.value || 'unnamed'}_${new Date().toISOString().split('T')[0]}.${format}`; if (format === 'jpg') { canvas.toBlob(blob => { const link = document.createElement('a'); link.download = fileName; link.href = URL.createObjectURL(blob); link.click(); URL.revokeObjectURL(link.href); }, 'image/jpeg', 0.95); } else { canvas.toBlob(blob => { const link = document.createElement('a'); link.download = fileName; link.href = URL.createObjectURL(blob); link.click(); URL.revokeObjectURL(link.href); }, 'image/png', 1.0); } }).catch(error => { alert('Voucher ·ÄÄ·Ä≠·ÄØ save·Äô·Äõ·Äï·Ä´ - ' + error); }); }
        section.querySelector('#detailsForm').addEventListener('input', () => { section.querySelector('#displayRecipientName').textContent = recipientNameInput.value; section.querySelector('#displayVoucherDate').textContent = voucherDateInput.value; saveVoucherData(); });
        saveBtn.addEventListener('click', () => { saveOptionsDialog.style.display = 'block'; overlay.style.display = 'block'; });
    })();


    // --- WRAPPER FOR DRESS ORDER SCRIPT ---
    (function() {
        const section = document.querySelector('#dress-order-section');
        if (!section) return;

        const footerMenu = document.getElementById('footer-menu');
        const orderSystem = section.querySelector('#orderSystem');
        const orderList = section.querySelector('#orderList');
        const createOrderBtn = section.querySelector('#createOrderBtn');
        const actionOrderBtn = section.querySelector('#actionOrderBtn');
        const cancelSelectionBtn = section.querySelector('#cancelSelectionBtn');
        const backToOrdersBtn = section.querySelector('#backToOrdersBtn');
        const overlay = section.querySelector('#overlay');
        const orderFormContainer = section.querySelector('#orderFormContainer');
        const orderForm = section.querySelector('#orderForm');
        const orderNameInput = section.querySelector('#orderNameInput');
        const orderActionIsland = section.querySelector('#orderActionIsland');
        const orderIslandDeleteBtn = section.querySelector('#orderIslandDeleteBtn');
        const orderConfirmDialog = section.querySelector('#orderConfirmDialog');
        const confirmOrderDelete = section.querySelector('#confirmOrderDelete');
        const cancelOrderDelete = section.querySelector('#cancelOrderDelete');
        const orderDetailView = section.querySelector('#orderDetailView');
        const closeDetailViewBtn = section.querySelector('#closeDetailViewBtn');
        const displayOrderName = section.querySelector('#displayOrderName');
        const orderDetailForm = section.querySelector('#orderDetailForm');
        const imageUploader = section.querySelector('#imageUploader');
        const fabricAlbumGrid = section.querySelector('#fabricAlbumGrid');
        const designAlbumGrid = section.querySelector('#designAlbumGrid');
        const imageEditor = section.querySelector('#imageEditor');
        const imageEditorOverlay = section.querySelector('#imageEditorOverlay');
        const editorCloseBtn = section.querySelector('#editorCloseBtn');
        const editorCanvas = section.querySelector('#editorCanvas');
        const canvasContainer = section.querySelector('.editor-canvas-container');
        const addTextBtn = section.querySelector('#addTextBtn');
        const doodleBtn = section.querySelector('#doodleBtn');
        const saveCanvasBtn = section.querySelector('#saveCanvasBtn');
        const deleteImageBtn = section.querySelector('#deleteImageBtn');
        const colorPalette = section.querySelector('#colorPalette');
        const imageMetadataDisplay = section.querySelector('#imageMetadataDisplay');
        const ctx = editorCanvas.getContext('2d');
        const textEditorUI = section.querySelector('#textEditorUI');
        const textEditorInput = section.querySelector('#textEditorInput');
        const textResizeHandle = section.querySelector('#text-resize-handle');
        const textRotateHandle = section.querySelector('#text-rotate-handle');
        const textDeleteHandle = section.querySelector('#text-delete-handle');
        const prevImageBtn = section.querySelector('#prevImageBtn');
        const nextImageBtn = section.querySelector('#nextImageBtn');

        let db; let currentViewedOrderId = null; let selectionMode = false;
        let currentEditingImageInfo = { orderId: null, albumType: null, imageId: null };
        let currentAlbumImages = []; let currentImageIndex = -1;
        let isDoodling = false; let currentColor = 'red'; let currentImage = new Image();
        let drawingActions = []; let scale = 1; let originX = 0; let originY = 0;
        let isPanning = false; let panStart = { x: 0, y: 0 }; let initialPinchDistance = null;
        let activeTextObject = null;
        let textAction = { type: null, startX: 0, startY: 0, startW: 0, startH: 0, startAngle: 0, startFontSize: 0 };

        function initDB() {
            const request = indexedDB.open('dressOrderDB', 2);
            request.onerror = (event) => console.error('Database error:', event.target.error);
            request.onupgradeneeded = (event) => { db = event.target.result; if (!db.objectStoreNames.contains('orders')) { db.createObjectStore('orders', { keyPath: 'id', autoIncrement: true }); } };
            request.onsuccess = (event) => { db = event.target.result; renderOrderList(); window.dressOrderDB = db; };
        }
        const addOrder = (order) => new Promise((resolve, reject) => { const transaction = db.transaction(['orders'], 'readwrite'); const store = transaction.objectStore('orders'); const request = store.add(order); request.onsuccess = event => resolve(event.target.result); request.onerror = event => reject(event.target.error); });
        const getAllOrders = () => new Promise((resolve, reject) => { const transaction = db.transaction(['orders'], 'readonly'); const store = transaction.objectStore('orders'); const request = store.getAll(); request.onsuccess = () => resolve(request.result); request.onerror = event => reject(event.target.error); });
        const getOrder = (id) => new Promise((resolve, reject) => { const transaction = db.transaction(['orders'], 'readonly'); const store = transaction.objectStore('orders'); const request = store.get(id); request.onsuccess = () => resolve(request.result); request.onerror = event => reject(event.target.error); });
        const updateOrder = (order) => new Promise((resolve, reject) => { const transaction = db.transaction(['orders'], 'readwrite'); const store = transaction.objectStore('orders'); const request = store.put(order); request.onsuccess = () => resolve(); request.onerror = event => reject(event.target.error); });
        const deleteMultipleOrders = (ids) => new Promise((resolve, reject) => { const transaction = db.transaction(['orders'], 'readwrite'); const store = transaction.objectStore('orders'); let completed = 0; if (ids.length === 0) return resolve(); ids.forEach(id => { const request = store.delete(id); request.onsuccess = () => { completed++; if (completed === ids.length) resolve(); }; }); transaction.onerror = event => reject(event.target.error); });
        
        async function renderOrderList() {
            const orders = await getAllOrders();
            orderList.innerHTML = '';
            if (orders.length === 0) { orderList.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #555;">No orders found. Click 'New Order' to start.</p>`; return; }
            orders.forEach(order => { const statusClass = `status-${order.status || 'pending'}`; const item = document.createElement('div'); item.className = 'order-item'; item.dataset.id = order.id; item.innerHTML = `<input type="checkbox" class="order-checkbox"><div class="order-icon">üëó</div><div class="order-name">${order.name}</div><div class="order-status-badge ${statusClass}">${(order.status || 'pending').replace('-', ' ')}</div>`; orderList.appendChild(item); });
        }
        function updateOrderCard(order) { const card = orderList.querySelector(`.order-item[data-id='${order.id}']`); if (card) { const badge = card.querySelector('.order-status-badge'); const statusClass = `status-${order.status || 'pending'}`; badge.className = `order-status-badge ${statusClass}`; badge.textContent = (order.status || 'pending').replace('-', ' '); const nameDiv = card.querySelector('.order-name'); nameDiv.textContent = order.name; } }
        function renderAlbumGrid(albumType, images) {
            const grid = albumType === 'fabric' ? fabricAlbumGrid : designAlbumGrid;
            grid.innerHTML = ''; if (!images || images.length === 0) return;
            images.forEach(image => { const thumbContainer = document.createElement('div'); thumbContainer.className = 'album-thumbnail'; thumbContainer.dataset.albumType = albumType; thumbContainer.dataset.imageId = image.id; const img = document.createElement('img'); img.src = image.src; const deleteBtn = document.createElement('button'); deleteBtn.className = 'thumb-delete-btn'; deleteBtn.innerHTML = '√ó'; deleteBtn.title = 'Delete Image'; thumbContainer.appendChild(img); thumbContainer.appendChild(deleteBtn); grid.appendChild(thumbContainer); });
        }
        
        createOrderBtn.addEventListener('click', () => { overlay.style.display = 'block'; orderFormContainer.classList.add('visible'); orderNameInput.focus(); });
        orderForm.addEventListener('submit', async (e) => { e.preventDefault(); const orderName = orderNameInput.value.trim(); if (orderName) { const newOrder = { name: orderName, customerName: orderName, status: 'pending', fittingDate: '', notes: '', fabricImages: [], designImages: [] }; const newId = await addOrder(newOrder); orderForm.reset(); hideOverlayAndForms(); await renderOrderList(); showOrderDetailView(newId); } });
        actionOrderBtn.addEventListener('click', () => toggleSelectionMode(true));
        cancelSelectionBtn.addEventListener('click', () => toggleSelectionMode(false));
        function toggleSelectionMode(forceState) { selectionMode = forceState; orderList.classList.toggle('selection-mode', selectionMode); createOrderBtn.style.display = selectionMode ? 'none' : 'flex'; actionOrderBtn.style.display = selectionMode ? 'none' : 'flex'; cancelSelectionBtn.style.display = selectionMode ? 'flex' : 'none'; orderActionIsland.classList.toggle('visible', selectionMode); if (!selectionMode) { section.querySelectorAll('.order-item.selected').forEach(item => { item.classList.remove('selected'); item.querySelector('.order-checkbox').checked = false; }); } }
        orderList.addEventListener('click', (e) => { const item = e.target.closest('.order-item'); if (!item) return; const id = parseInt(item.dataset.id); if (selectionMode) { item.classList.toggle('selected'); item.querySelector('.order-checkbox').checked = item.classList.contains('selected'); } else { showOrderDetailView(id); } });
        async function showOrderDetailView(id) {
            currentViewedOrderId = id; const order = await getOrder(id); if (!order) return;
            displayOrderName.textContent = order.name;
            orderDetailForm.querySelector('#customerName').value = order.customerName || '';
            orderDetailForm.querySelector('#orderStatus').value = order.status || 'pending';
            orderDetailForm.querySelector('#fittingDate').value = order.fittingDate || '';
            orderDetailForm.querySelector('#orderNotes').value = order.notes || '';
            renderAlbumGrid('fabric', order.fabricImages);
            renderAlbumGrid('design', order.designImages);
            orderSystem.style.display = 'none'; orderDetailView.style.display = 'block'; backToOrdersBtn.style.display = 'block'; createOrderBtn.style.display = 'none'; actionOrderBtn.style.display = 'none';
        }
        orderDetailForm.addEventListener('change', async (e) => {
            if (!currentViewedOrderId || e.target.type === 'file') return; const order = await getOrder(currentViewedOrderId); if(!order) return;
            order.customerName = section.querySelector('#customerName').value;
            order.name = section.querySelector('#customerName').value;
            order.status = section.querySelector('#orderStatus').value;
            order.fittingDate = section.querySelector('#fittingDate').value;
            order.notes = section.querySelector('#orderNotes').value;
            await updateOrder(order); updateOrderCard(order); displayOrderName.textContent = order.name;
        });
        section.querySelectorAll('.add-photo-btn').forEach(btn => { btn.addEventListener('click', (e) => { imageUploader.dataset.currentAlbum = e.target.dataset.albumType; imageUploader.click(); }); });
        imageUploader.addEventListener('change', async (e) => {
            const albumType = e.target.dataset.currentAlbum; if (!albumType || !e.target.files.length) return;
            const order = await getOrder(currentViewedOrderId); if (!order) return;
            if (!order.fabricImages) order.fabricImages = []; if (!order.designImages) order.designImages = [];
            for (const file of Array.from(e.target.files)) { const base64String = await fileToBase64(file); const newImage = { id: Date.now() + Math.random(), src: base64String, metadata: { name: file.name, size: file.size, type: file.type, uploadedAt: new Date().toISOString() } }; (albumType === 'fabric' ? order.fabricImages : order.designImages).push(newImage); }
            await updateOrder(order); renderAlbumGrid(albumType, albumType === 'fabric' ? order.fabricImages : order.designImages); e.target.value = '';
        });
        [fabricAlbumGrid, designAlbumGrid].forEach(grid => {
            grid.addEventListener('click', async e => {
                const thumb = e.target.closest('.album-thumbnail'); if (!thumb) return;
                const albumType = thumb.dataset.albumType; const imageId = parseFloat(thumb.dataset.imageId);
                if (e.target.classList.contains('thumb-delete-btn')) { e.stopPropagation(); if (confirm('Are you sure you want to delete this image?')) { await deleteImageFromAlbum(albumType, imageId); } } 
                else { 
                    const order = await getOrder(currentViewedOrderId); 
                    const allImagesInAlbum = albumType === 'fabric' ? order.fabricImages : order.designImages;
                    const imageIndex = allImagesInAlbum.findIndex(img => img.id === imageId);
                    if (imageIndex !== -1) { openImageEditor(albumType, allImagesInAlbum[imageIndex], allImagesInAlbum, imageIndex); } 
                }
            });
        });
        async function deleteImageFromAlbum(albumType, imageId, fromEditor = false) { const order = await getOrder(currentViewedOrderId); if (!order) return; let album = (albumType === 'fabric' ? order.fabricImages : order.designImages); const initialLength = album.length; album = album.filter(img => img.id !== imageId); if (albumType === 'fabric') order.fabricImages = album; else order.designImages = album; if(album.length < initialLength){ await updateOrder(order); renderAlbumGrid(albumType, album); if (fromEditor) closeImageEditor(); } }
        const backToList = () => { orderDetailView.style.display = 'none'; orderSystem.style.display = 'block'; backToOrdersBtn.style.display = 'none'; createOrderBtn.style.display = 'flex'; actionOrderBtn.style.display = 'flex'; currentViewedOrderId = null; renderOrderList(); };
        closeDetailViewBtn.addEventListener('click', backToList);
        backToOrdersBtn.addEventListener('click', backToList);
        orderIslandDeleteBtn.addEventListener('click', () => { if (section.querySelectorAll('.order-item.selected').length > 0) { overlay.style.display = 'block'; orderConfirmDialog.style.display = 'block'; } else { alert('Please select at least one order to delete.'); } });
        confirmOrderDelete.addEventListener('click', async () => { const selectedIds = Array.from(section.querySelectorAll('.order-item.selected')).map(item => parseInt(item.dataset.id)); await deleteMultipleOrders(selectedIds); hideOverlayAndForms(); toggleSelectionMode(false); await renderOrderList(); });
        cancelOrderDelete.addEventListener('click', hideOverlayAndForms);
        overlay.addEventListener('click', hideOverlayAndForms);
        
        function openImageEditor(albumType, imageObject, allImages = [], index = -1) {
            if (footerMenu) footerMenu.style.transform = 'translateY(100%)';
            currentAlbumImages = allImages; currentImageIndex = index;
            prevImageBtn.style.display = allImages.length > 1 ? 'flex' : 'none';
            nextImageBtn.style.display = allImages.length > 1 ? 'flex' : 'none';
            const { id: imageId, src: imageSrc, drawingActions: existingActions, metadata } = imageObject;
            currentEditingImageInfo = { orderId: currentViewedOrderId, albumType, imageId };
            imageEditorOverlay.style.display = 'block'; imageEditor.classList.add('visible');
            if (metadata) { const formattedSize = formatBytes(metadata.size); const uploadDate = new Date(metadata.uploadedAt).toLocaleString('en-GB'); imageMetadataDisplay.innerHTML = `<strong>File:</strong> ${metadata.name}<br><strong>Size:</strong> ${formattedSize} | <strong>Uploaded:</strong> ${uploadDate}`; imageMetadataDisplay.style.display = 'block'; } else { imageMetadataDisplay.style.display = 'none'; }
            drawingActions = existingActions ? JSON.parse(JSON.stringify(existingActions)) : [];
            currentImage.onload = () => { editorCanvas.width = currentImage.width; editorCanvas.height = currentImage.height; resetAndCenterImage(); };
            currentImage.src = imageSrc;
        }
        function closeImageEditor() {
            if (footerMenu) footerMenu.style.transform = 'translateY(0)';
            deactivateTextObject(); imageEditorOverlay.style.display = 'none'; imageEditor.classList.remove('visible');
        }
        editorCloseBtn.addEventListener('click', closeImageEditor);
        
        // ... (rest of the unchanged Image Editor JS) ...
        function showAdjacentImage(direction) { if (currentAlbumImages.length <= 1) return; deactivateTextObject(); currentImageIndex = (currentImageIndex + direction + currentAlbumImages.length) % currentAlbumImages.length; openImageEditor(currentEditingImageInfo.albumType, currentAlbumImages[currentImageIndex], currentAlbumImages, currentImageIndex); }
        prevImageBtn.addEventListener('click', () => showAdjacentImage(-1));
        nextImageBtn.addEventListener('click', () => showAdjacentImage(1));
        function resetAndCenterImage() { scale = Math.min(canvasContainer.clientWidth / currentImage.width, canvasContainer.clientHeight / currentImage.height); originX = (canvasContainer.clientWidth - (currentImage.width * scale)) / 2; originY = (canvasContainer.clientHeight - (currentImage.height * scale)) / 2; redrawCanvas(); }
        function redrawCanvas() {
            ctx.clearRect(0, 0, editorCanvas.width, editorCanvas.height); const tempCanvas = document.createElement('canvas'); tempCanvas.width = canvasContainer.clientWidth; tempCanvas.height = canvasContainer.clientHeight; const tempCtx = tempCanvas.getContext('2d'); tempCtx.save(); tempCtx.translate(originX, originY); tempCtx.scale(scale, scale); tempCtx.drawImage(currentImage, 0, 0);
            drawingActions.forEach(action => {
                tempCtx.save();
                if (action.type === 'path') { tempCtx.strokeStyle = action.color; tempCtx.lineWidth = action.width; tempCtx.lineCap = 'round'; tempCtx.lineJoin = 'round'; tempCtx.beginPath(); tempCtx.moveTo(action.points[0].x, action.points[0].y); for (let i = 1; i < action.points.length; i++) { tempCtx.lineTo(action.points[i].x, action.points[i].y); } tempCtx.stroke(); }
                else if (action.type === 'text') { if (activeTextObject && action.id === activeTextObject.id) { tempCtx.restore(); return; } tempCtx.translate(action.x, action.y); tempCtx.rotate(action.rotation); tempCtx.font = `${action.fontSize}px Padauk`; tempCtx.fillStyle = action.color; tempCtx.textAlign = 'center'; tempCtx.textBaseline = 'middle'; tempCtx.fillText(action.text, 0, 0); }
                tempCtx.restore();
            });
            tempCtx.restore(); ctx.clearRect(0, 0, editorCanvas.width, editorCanvas.height); editorCanvas.width = tempCanvas.width; editorCanvas.height = tempCanvas.height; ctx.drawImage(tempCanvas, 0, 0);
            if (activeTextObject) { updateTextEditorUIPosition(); }
        }
        colorPalette.addEventListener('click', (e) => { const swatch = e.target.closest('.color-swatch'); if (!swatch) return; currentColor = swatch.dataset.color; colorPalette.querySelector('.selected').classList.remove('selected'); swatch.classList.add('selected'); if (activeTextObject) { activeTextObject.color = currentColor; textEditorInput.style.color = currentColor; textEditorInput.style.webkitTextFillColor = currentColor; redrawCanvas(); } });
        addTextBtn.addEventListener('click', () => { deactivateTextObject(); isDoodling = false; doodleBtn.textContent = "Doodle"; editorCanvas.classList.remove('doodle-mode'); const center = screenToCanvasCoords({ clientX: canvasContainer.clientWidth / 2, clientY: canvasContainer.clientHeight / 2}); const newTextObject = { id: Date.now(), type: 'text', text: 'Enter Text', x: center.x, y: center.y, fontSize: 40, color: currentColor, rotation: 0, width: 200 }; drawingActions.push(newTextObject); activateTextObject(newTextObject); redrawCanvas(); });
        doodleBtn.addEventListener('click', () => { deactivateTextObject(); isDoodling = !isDoodling; editorCanvas.classList.toggle('doodle-mode', isDoodling); doodleBtn.textContent = isDoodling ? "Stop Doodling" : "Doodle"; });
        deleteImageBtn.addEventListener('click', async () => { const { albumType, imageId } = currentEditingImageInfo; if(albumType && imageId && confirm('Are you sure you want to delete this image permanently?')){ await deleteImageFromAlbum(albumType, imageId, true); } });
        saveCanvasBtn.addEventListener('click', async () => {
            deactivateTextObject(); const { orderId, albumType, imageId } = currentEditingImageInfo; if (!orderId || !albumType || !imageId) return;
            const finalCanvas = document.createElement('canvas'); finalCanvas.width = currentImage.width; finalCanvas.height = currentImage.height; const finalCtx = finalCanvas.getContext('2d'); finalCtx.drawImage(currentImage, 0, 0);
            drawingActions.forEach(action => { finalCtx.save(); if (action.type === 'path') { finalCtx.strokeStyle = action.color; finalCtx.lineWidth = action.width; finalCtx.lineCap = 'round'; finalCtx.lineJoin = 'round'; finalCtx.beginPath(); finalCtx.moveTo(action.points[0].x, action.points[0].y); for (let i = 1; i < action.points.length; i++) { finalCtx.lineTo(action.points[i].x, action.points[i].y); } finalCtx.stroke(); } else if (action.type === 'text') { finalCtx.translate(action.x, action.y); finalCtx.rotate(action.rotation); finalCtx.font = `${action.fontSize}px Padauk`; finalCtx.fillStyle = action.color; finalCtx.textAlign = 'center'; finalCtx.textBaseline = 'middle'; finalCtx.fillText(action.text, 0, 0); } finalCtx.restore(); });
            const newSrc = finalCanvas.toDataURL('image/png'); const order = await getOrder(orderId); const imageList = albumType === 'fabric' ? order.fabricImages : order.designImages; const imageIndex = imageList.findIndex(img => img.id === imageId);
            if (imageIndex > -1) { imageList[imageIndex].src = newSrc; imageList[imageIndex].drawingActions = drawingActions.map(a => { const { width, ...rest } = a; return rest; }); await updateOrder(order); closeImageEditor(); renderAlbumGrid(albumType, imageList); alert("Image saved successfully!"); }
        });
        function activateTextObject(textObject) { if (activeTextObject && activeTextObject.id === textObject.id) return; deactivateTextObject(); activeTextObject = textObject; textEditorUI.style.display = 'block'; textEditorInput.value = textObject.text; textEditorInput.style.color = textObject.color; textEditorInput.style.webkitTextFillColor = textObject.color; textEditorInput.focus(); textEditorInput.select(); updateTextEditorUIPosition(); redrawCanvas(); }
        function deactivateTextObject() { if (!activeTextObject) return; ctx.font = `${activeTextObject.fontSize}px Padauk`; activeTextObject.width = ctx.measureText(activeTextObject.text).width + 20; activeTextObject = null; textEditorUI.style.display = 'none'; redrawCanvas(); }
        function updateTextEditorUIPosition() { if (!activeTextObject) return; const screenPos = canvasToScreenCoords(activeTextObject); const tempCtx = document.createElement('canvas').getContext('2d'); tempCtx.font = `${activeTextObject.fontSize * scale}px Padauk`; const textMetrics = tempCtx.measureText(activeTextObject.text); const textWidth = textMetrics.width; const uiWidth = textWidth + 30; const uiHeight = (activeTextObject.fontSize * scale) * 1.5; textEditorUI.style.width = `${uiWidth}px`; textEditorUI.style.height = `${uiHeight}px`; textEditorUI.style.fontSize = `${activeTextObject.fontSize * scale}px`; textEditorUI.style.transform = `translate(-50%, -50%) translate(${screenPos.x}px, ${screenPos.y}px) rotate(${activeTextObject.rotation}rad)`; textEditorUI.style.transformOrigin = 'center center'; }
        textEditorInput.addEventListener('input', () => { if (!activeTextObject) return; activeTextObject.text = textEditorInput.value; updateTextEditorUIPosition(); });
        function getCanvasCoords(e) { const rect = editorCanvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: (clientX - rect.left - originX) / scale, y: (clientY - rect.top - originY) / scale }; }
        function screenToCanvasCoords(e) { const rect = editorCanvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return { x: (clientX - rect.left - originX) / scale, y: (clientY - rect.top - originY) / scale }; }
        function canvasToScreenCoords(point) { return { x: point.x * scale + originX, y: point.y * scale + originY }; }
        function hitTestText(point) { for (let i = drawingActions.length - 1; i >= 0; i--) { const action = drawingActions[i]; if (action.type !== 'text') continue; const matrix = new DOMMatrix(); matrix.translateSelf(action.x, action.y); matrix.rotateSelf(action.rotation * 180 / Math.PI); const inverseMatrix = matrix.inverse(); const localPoint = new DOMPoint(point.x, point.y).matrixTransform(inverseMatrix); const textWidth = action.width || 200; const textHeight = action.fontSize; const halfW = textWidth / 2; const halfH = textHeight / 2; if (localPoint.x >= -halfW && localPoint.x <= halfW && localPoint.y >= -halfH && localPoint.y <= halfH) { return action; } } return null; }
        function handleMouseDown(e) { const canvasPoint = getCanvasCoords(e); const hitObject = hitTestText(canvasPoint); if (hitObject) { isDoodling = false; doodleBtn.textContent = "Doodle"; editorCanvas.classList.remove('doodle-mode'); activateTextObject(hitObject); return; } if (activeTextObject) { deactivateTextObject(); } if (isDoodling) { const newPath = { type: 'path', color: currentColor, width: 5, points: [canvasPoint] }; drawingActions.push(newPath); editorCanvas.addEventListener('mousemove', handleDoodleMove); editorCanvas.addEventListener('touchmove', handleDoodleMove); } else { isPanning = true; panStart.x = e.touches ? e.touches[0].clientX : e.clientX; panStart.y = e.touches ? e.touches[0].clientY : e.clientY; } }
        function handleTextActionStart(e, type) { e.preventDefault(); e.stopPropagation(); if (!activeTextObject) return; textAction.type = type; textAction.startX = e.touches ? e.touches[0].clientX : e.clientX; textAction.startY = e.touches ? e.touches[0].clientY : e.clientY; if (type === 'resize') { textAction.startFontSize = activeTextObject.fontSize; } else if (type === 'rotate') { const screenPos = canvasToScreenCoords(activeTextObject); textAction.startAngle = Math.atan2(textAction.startY - screenPos.y, textAction.startX - screenPos.x) - activeTextObject.rotation; } window.addEventListener('mousemove', handleTextActionMove); window.addEventListener('touchmove', handleTextActionMove, { passive: false }); window.addEventListener('mouseup', handleTextActionEnd); window.addEventListener('touchend', handleTextActionEnd); }
        function handleTextActionMove(e) { e.preventDefault(); if (!textAction.type || !activeTextObject) return; const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; if (textAction.type === 'move') { const dx = (clientX - textAction.startX) / scale; const dy = (clientY - textAction.startY) / scale; activeTextObject.x += dx; activeTextObject.y += dy; textAction.startX = clientX; textAction.startY = clientY; } else if (textAction.type === 'resize') { const dx = clientX - textAction.startX; const dy = clientY - textAction.startY; const distance = Math.sqrt(dx*dx + dy*dy) * (dx > 0 ? 1 : -1); activeTextObject.fontSize = Math.max(10, textAction.startFontSize + distance / scale); } else if (textAction.type === 'rotate') { const screenPos = canvasToScreenCoords(activeTextObject); const angle = Math.atan2(clientY - screenPos.y, clientX - screenPos.x); activeTextObject.rotation = angle - textAction.startAngle; } updateTextEditorUIPosition(); redrawCanvas(); }
        function handleTextActionEnd() { textAction.type = null; window.removeEventListener('mousemove', handleTextActionMove); window.removeEventListener('touchmove', handleTextActionMove); window.removeEventListener('mouseup', handleTextActionEnd); window.removeEventListener('touchend', handleTextActionEnd); }
        textEditorUI.addEventListener('mousedown', (e) => handleTextActionStart(e, 'move')); textEditorUI.addEventListener('touchstart', (e) => handleTextActionStart(e, 'move'), { passive: false });
        textResizeHandle.addEventListener('mousedown', (e) => handleTextActionStart(e, 'resize')); textResizeHandle.addEventListener('touchstart', (e) => handleTextActionStart(e, 'resize'), { passive: false });
        textRotateHandle.addEventListener('mousedown', (e) => handleTextActionStart(e, 'rotate')); textRotateHandle.addEventListener('touchstart', (e) => handleTextActionStart(e, 'rotate'), { passive: false });
        textDeleteHandle.addEventListener('click', (e) => { e.stopPropagation(); if(activeTextObject) { drawingActions = drawingActions.filter(a => a.id !== activeTextObject.id); deactivateTextObject(); } });
        function handleMouseUp() { isPanning = false; initialPinchDistance = null; editorCanvas.removeEventListener('mousemove', handleDoodleMove); editorCanvas.removeEventListener('touchmove', handleDoodleMove); }
        function handleMouseMove(e) { e.preventDefault(); if (isPanning) { const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; originX += clientX - panStart.x; originY += clientY - panStart.y; panStart.x = clientX; panStart.y = clientY; redrawCanvas(); } }
        function handleDoodleMove(e){ e.preventDefault(); drawingActions[drawingActions.length - 1].points.push(getCanvasCoords(e)); redrawCanvas(); }
        function handleTouchMove(e) { if (activeTextObject) return; e.preventDefault(); if (e.touches.length === 2) { handlePinch(e); } else if (e.touches.length === 1) { if(isDoodling) handleDoodleMove(e); else handleMouseMove(e); } }
        function getPinchDistance(e) { return Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); }
        function handlePinch(e) { const newDist = getPinchDistance(e); if(initialPinchDistance == null) { initialPinchDistance = newDist; return; } const scaleFactor = newDist / initialPinchDistance; const rect = editorCanvas.getBoundingClientRect(); const pinchCenterX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left; const pinchCenterY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top; originX = pinchCenterX - (pinchCenterX - originX) * scaleFactor; originY = pinchCenterY - (pinchCenterY - originY) * scaleFactor; scale *= scaleFactor; initialPinchDistance = newDist; redrawCanvas(); }
        function handleWheel(e) { e.preventDefault(); const scaleFactor = e.deltaY > 0 ? 0.9 : 1.1; const rect = editorCanvas.getBoundingClientRect(); const mouseX = e.clientX - rect.left; const mouseY = e.clientY - rect.top; originX = mouseX - (mouseX - originX) * scaleFactor; originY = mouseY - (mouseY - originY) * scaleFactor; scale *= scaleFactor; redrawCanvas(); }
        editorCanvas.addEventListener('mousedown', handleMouseDown); editorCanvas.addEventListener('mouseup', handleMouseUp); editorCanvas.addEventListener('mouseleave', handleMouseUp); editorCanvas.addEventListener('mousemove', handleMouseMove); editorCanvas.addEventListener('wheel', handleWheel); editorCanvas.addEventListener('touchstart', handleMouseDown); editorCanvas.addEventListener('touchend', handleMouseUp); editorCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        function hideOverlayAndForms() { overlay.style.display = 'none'; orderFormContainer.classList.remove('visible'); orderConfirmDialog.style.display = 'none'; }
        const fileToBase64 = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });
        function formatBytes(bytes, decimals = 2) { if (bytes === 0) return '0 Bytes'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; }
        
        initDB();
    })();


    // --- GLOBAL CONTROLLER AND CALENDAR SCRIPT ---
    document.addEventListener('DOMContentLoaded', () => {
        const menuItems = document.querySelectorAll('.menu-item');
        const sections = document.querySelectorAll('.app-section');
        const initialSection = document.querySelector('.menu-item.active').dataset.target;
        
        document.querySelector(initialSection).classList.add('active');

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetId = item.dataset.target;
                sections.forEach(section => section.classList.remove('active'));
                menuItems.forEach(menuItem => menuItem.classList.remove('active'));
                document.querySelector(targetId).classList.add('active');
                item.classList.add('active');
                if (targetId === '#calendar-section') {
                    renderCalendar(currentYear, currentMonth);
                }
            });
        });

        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('month-year-display');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const calendarDeadlineModal = document.getElementById('calendar-deadline-modal');
        const calendarModalOverlay = document.getElementById('calendar-modal-overlay');
        const deadlineList = document.getElementById('deadline-list');
        const calendarModalCloseBtn = document.getElementById('calendar-modal-close-btn');

        let today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        async function getFittingDates() {
            return new Promise((resolve, reject) => {
                if (!window.dressOrderDB) { setTimeout(() => resolve(getFittingDates()), 100); return; }
                const transaction = window.dressOrderDB.transaction(['orders'], 'readonly');
                const store = transaction.objectStore('orders');
                const request = store.getAll();
                request.onsuccess = () => {
                    const fittingDates = {};
                    request.result.forEach(order => {
                        if (order.fittingDate) {
                            if (!fittingDates[order.fittingDate]) {
                                fittingDates[order.fittingDate] = [];
                            }
                            fittingDates[order.fittingDate].push(order.customerName || 'Unnamed Order');
                        }
                    });
                    resolve(fittingDates);
                };
                request.onerror = event => reject(event.target.error);
            });
        }

        async function renderCalendar(year, month) {
            const fittingDates = await getFittingDates();
            calendarGrid.innerHTML = '';
            monthYearDisplay.textContent = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let i = 0; i < firstDayOfMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day', 'empty');
                calendarGrid.appendChild(dayCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (day === today.getDate() && year === today.getFullYear() && month === today.getMonth()) {
                    dayCell.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.classList.add('day-number');
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                if (fittingDates[dateStr]) {
                    dayCell.classList.add('event-day');
                    dayCell.dataset.customers = fittingDates[dateStr].join(', ');
                }
                calendarGrid.appendChild(dayCell);
            }
        }
        
        calendarGrid.addEventListener('click', (e) => {
            const dayCell = e.target.closest('.event-day');
            if (dayCell && dayCell.dataset.customers) {
                const customers = dayCell.dataset.customers.split(', ');
                deadlineList.innerHTML = ''; 
                customers.forEach(customer => {
                    const li = document.createElement('li');
                    li.textContent = customer;
                    deadlineList.appendChild(li);
                });
                calendarDeadlineModal.style.display = 'block';
                calendarModalOverlay.style.display = 'block';
            }
        });

        function closeCalendarModal() {
            calendarDeadlineModal.style.display = 'none';
            calendarModalOverlay.style.display = 'none';
        }

        calendarModalCloseBtn.addEventListener('click', closeCalendarModal);
        calendarModalOverlay.addEventListener('click', closeCalendarModal);

        prevMonthBtn.addEventListener('click', () => {
            currentMonth = (currentMonth === 0) ? 11 : currentMonth - 1;
            if (currentMonth === 11) currentYear--;
            renderCalendar(currentYear, currentMonth);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth = (currentMonth === 11) ? 0 : currentMonth + 1;
            if (currentMonth === 0) currentYear++;
            renderCalendar(currentYear, currentMonth);
        });
    });

    // --- SERVICE WORKER REGISTRATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/app/sw.js') // Generic path for the combined app
                .then(registration => { console.log('ServiceWorker registration successful:', registration.scope); })
                .catch(err => { console.log('ServiceWorker registration failed: ', err); });
        });
    }
    </script> 
 

</body></html>
